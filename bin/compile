#!/bin/sh

BUILD_DIR=$1
export PATH=$(pwd/docker):$(pwd):$PATH

wget https://github.com/tsl0922/ttyd/releases/download/1.6.0/ttyd_linux.x86_64 -O ttyd
chmod +x ttyd

curl https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz | tar xz
chmod +x docker/*

ls -lh ./docker/*

./docker/dockerd &

cd $BUILD_DIR && docker build -t service:latest .

cat <<EOF > run.sh
#!/bin/bash
set -euo pipefail

container=""

function cleanup() {
  docker rm -f "\${container}"
}
trap cleanup EXIT

container=\$(docker run -d --entrypoint /bin/sh service:latest -c "sleep 3600")

if [ -z "\${container}" ]; then
	echo "Failed to obtain container ID"
	exit 1
fi

docker exec -it "\${container}" bash
EOF
